using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.AI;

[RequireComponent(typeof(Animator))] // Requires animator with parameter "flySpeed" catering for 0, 1 (idle, flap)

public class FlyMovimentation : MonoBehaviour
{
    private Animator animator;

    public int speed;
    public int disEntreRot;

    private Vector3 atualPos, atualTarget;

    public Vector2 groundDistanceMinMax;

    public Vector2 animSpeedMinMax;

    private NavMeshAgent nav;

    public float targetHeight;

    public float disRaycast;


    void Start()
    {
        nav = GetComponent<NavMeshAgent>();
        targetHeight = Random.Range(groundDistanceMinMax.x, groundDistanceMinMax.y);
        atualTarget = RandomNavmeshLocation(0.5f);
        nav.SetDestination(atualTarget);

    }
    void FixedUpdate()
    {
        atualPos = new Vector3 (transform.position.x, transform.position.y-nav.baseOffset, transform.position.z);
        float step = speed * Time.deltaTime;

        
        if (distanceFromTarget(atualPos, atualTarget) < nav.stoppingDistance + 1) {

            atualTarget = RandomNavmeshLocation(disEntreRot);

            nav.SetDestination(atualTarget);
            
            
            

        }

        if (transform.position.y >= targetHeight)
        {
            float offsetDistance;
            RaycastHit hit;
            if (Physics.Raycast(transform.position, -Vector3.up * disRaycast, out hit))
            {
                offsetDistance = hit.distance;
                Debug.DrawLine(transform.position, hit.point, Color.cyan);
                targetHeight = hit.point.y - Random.Range(groundDistanceMinMax.x, groundDistanceMinMax.y);
            }

        }
        else
        {
            nav.baseOffset = Mathf.Lerp(nav.baseOffset, targetHeight, step);

        }

    }
    public Vector3 RandomNavmeshLocation(float radius)
    {
        Vector3 randomDirection = Random.insideUnitSphere * radius;
        randomDirection += transform.position;
        NavMeshHit hit;
        Vector3 finalPosition = Vector3.zero;
        if (NavMesh.SamplePosition(randomDirection, out hit, radius, 1))
        {
            finalPosition = hit.position;
        }
        return finalPosition;
    }
    private float distanceFromTarget(Vector3 atual, Vector3 target) {

        return Vector3.Distance(atual, target);
    }


    // Select a new direction to fly in randomly
    
}